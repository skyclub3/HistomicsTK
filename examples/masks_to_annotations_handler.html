

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Masks to annotations workflow &mdash; HistomicsTK 0.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Polygon merger" href="polygon_merger.html" />
    <link rel="prev" title="Annotations to masks workflow" href="annotations_to_masks_handler.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> HistomicsTK
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-docs.html">API Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="wsi-io-using-large-image.html">Reading Whole-slide Images using Large-image</a></li>
<li class="toctree-l2"><a class="reference internal" href="color-deconvolution.html">Color Deconvolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="color-normalization-and-augmentation.html">Color normalization</a></li>
<li class="toctree-l2"><a class="reference internal" href="color-normalization-and-augmentation.html#&quot;Smart&quot;-color-augmentation">“Smart” color augmentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="nuclei-segmentation.html">Nuclei Segmentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="positive-pixel-count.html">Positive Pixel Count</a></li>
<li class="toctree-l2"><a class="reference internal" href="annotations_to_masks_handler.html">Annotations to masks workflow</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Masks to annotations workflow</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#1.-Constants-&amp;-prep-work">1. Constants &amp; prep work</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Let's-inspect-the-ground-truth-codes-file">Let’s inspect the ground truth codes file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Read-and-visualize-mask">Read and visualize mask</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#2.-Get-contours-from-mask">2. Get contours from mask</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#This-is-the-core-method-you-want-to-look-at">This is the core method you want to look at</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Extract-contours">Extract contours</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Let's-inspect-the-resultant-contours-dataframe">Let’s inspect the resultant contours dataframe</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#3.-Get-annotation-documents-from-contours">3. Get annotation documents from contours</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#This-is-the-core-method-you-want-to-look-at">This is the core method you want to look at</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Get-annotation-documents">Get annotation documents</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Let's-inspect-one-of-the-documents.">Let’s inspect one of the documents.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Now-we-post-it-to-DSA-HistomicsTK-slide">Now we post it to DSA HistomicsTK slide</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#4.-[EXTRA]---Explore-some-of-the-inner-workings">4. [EXTRA] - Explore some of the inner workings</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Core-method-being-called-to-get-contours-from-binary-mask">Core method being called to get contours from binary mask</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="polygon_merger.html">Polygon merger</a></li>
<li class="toctree-l2"><a class="reference internal" href="polygon_merger_v2.html">Polygon merger v2</a></li>
<li class="toctree-l2"><a class="reference internal" href="tissue_detection.html">Tissue Detection module</a></li>
<li class="toctree-l2"><a class="reference internal" href="cellularity_detection_thresholding.html">Cellularity detection using thresholding</a></li>
<li class="toctree-l2"><a class="reference internal" href="cellularity_detection_superpixels.html">Cellularity detection using superpixels</a></li>
<li class="toctree-l2"><a class="reference internal" href="workflows.html">Workflows</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authors.html">Credits</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">HistomicsTK</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../examples.html">Examples</a> &raquo;</li>
        
      <li>Masks to annotations workflow</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/examples/masks_to_annotations_handler.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    min-width: 5ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Masks-to-annotations-workflow">
<h1>Masks to annotations workflow<a class="headerlink" href="#Masks-to-annotations-workflow" title="Permalink to this headline">¶</a></h1>
<p><strong>Overview:</strong></p>
<p>This includes two key functionalities:</p>
<ul class="simple">
<li><p>Parsing annotatoins from a groung truth mask into contours (pandas dataframe)</p></li>
<li><p>Parsing contours into a format that is compatible with large_image annotation schema and ready to push for visualization in Digital Slide Archive HistomicsTK.</p></li>
</ul>
<p>This extends on some of the workflows described in Amgad et al, 2019:</p>
<p><strong>Mohamed Amgad, Habiba Elfandy, Hagar Hussein, …, Jonathan Beezley, Deepak R Chittajallu, David Manthey, David A Gutman, Lee A D Cooper, Structured crowdsourcing enables convolutional segmentation of histology images, Bioinformatics, 2019, btz083</strong></p>
<p>This slide used as a test example:</p>
<p><a class="reference external" href="http://candygram.neurology.emory.edu:8080/histomicstk#?image=5d586d76bd4404c6b1f286ae&amp;bounds=54743%2C32609%2C68828%2C39395%2C0">TCGA-A2-A0YE-01Z-00-DX1</a></p>
<p><strong>Where to look?</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">|</span><span class="n">_</span> <span class="n">histomicstk</span><span class="o">/</span>
<span class="o">|</span>   <span class="o">|</span>
<span class="o">|</span>   <span class="o">|</span><span class="n">_annotations_and_masks</span><span class="o">/</span>
<span class="o">|</span>      <span class="o">|</span><span class="n">_masks_to_annotations_handler</span><span class="o">.</span><span class="n">py</span>
<span class="o">|</span>
<span class="o">|</span><span class="n">_</span> <span class="n">plugin_tests</span><span class="o">/</span>
    <span class="o">|</span>
    <span class="o">|</span><span class="n">_annotations_and_masks</span><span class="o">/</span>
    <span class="o">|</span>  <span class="o">|</span><span class="n">_</span> <span class="n">masks_to_annotations_handler_test</span><span class="o">.</span><span class="n">py</span>
    <span class="o">|</span>
    <span class="o">|</span><span class="n">_test_files</span><span class="o">/</span>
       <span class="o">|</span><span class="n">_sample_GTcodes</span><span class="o">.</span><span class="n">csv</span>
       <span class="o">|</span><span class="n">_TCGA</span><span class="o">-</span><span class="n">A2</span><span class="o">-</span><span class="n">A0YE</span><span class="o">-</span><span class="mi">01</span><span class="n">Z</span><span class="o">-</span><span class="mi">00</span><span class="o">-</span><span class="n">DX1</span><span class="o">.</span><span class="mi">8</span><span class="n">A2E3094</span><span class="o">-</span><span class="mi">5755</span><span class="o">-</span><span class="mi">42</span><span class="n">BC</span><span class="o">-</span><span class="mi">969</span><span class="n">D</span><span class="o">-</span><span class="mi">7</span><span class="n">F0A2ECA0F39_left</span><span class="o">-</span><span class="mi">59206</span><span class="n">_top</span><span class="o">-</span><span class="mi">33505</span><span class="n">_mag</span><span class="o">-</span><span class="n">BASE</span><span class="o">.</span><span class="n">png</span>
       <span class="o">|</span><span class="n">_sample_contours_df</span><span class="o">.</span><span class="n">tsv</span>
</pre></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">CWD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CWD</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">))</span>

<span class="kn">import</span> <span class="nn">girder_client</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">read_csv</span>
<span class="kn">from</span> <span class="nn">imageio</span> <span class="kn">import</span> <span class="n">imread</span>
<span class="kn">from</span> <span class="nn">masks_to_annotations_handler</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_contours_from_bin_mask</span><span class="p">,</span> <span class="n">get_contours_from_mask</span><span class="p">,</span>
    <span class="n">get_single_annotation_document_from_contours</span><span class="p">,</span> <span class="n">get_annotation_documents_from_contours</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span>
</pre></div>
</div>
</div>
<div class="section" id="1.-Constants-&amp;-prep-work">
<h2>1. Constants &amp; prep work<a class="headerlink" href="#1.-Constants-&-prep-work" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># APIURL = &#39;http://demo.kitware.com/histomicstk/api/v1/&#39;</span>
<span class="c1"># SAMPLE_SLIDE_ID = &#39;5bbdee92e629140048d01b5d&#39;</span>
<span class="n">APIURL</span> <span class="o">=</span> <span class="s1">&#39;http://candygram.neurology.emory.edu:8080/api/v1/&#39;</span>
<span class="n">SAMPLE_SLIDE_ID</span> <span class="o">=</span> <span class="s1">&#39;5d586d76bd4404c6b1f286ae&#39;</span>

<span class="c1"># Connect to girder client</span>
<span class="n">gc</span> <span class="o">=</span> <span class="n">girder_client</span><span class="o">.</span><span class="n">GirderClient</span><span class="p">(</span><span class="n">apiUrl</span><span class="o">=</span><span class="n">APIURL</span><span class="p">)</span>
<span class="c1"># gc.authenticate(interactive=True)</span>
<span class="n">gc</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">apiKey</span><span class="o">=</span><span class="s1">&#39;kri19nTIGOkWH01TbzRqfohaaDWb6kPecRqGmemb&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Let's-inspect-the-ground-truth-codes-file">
<h3>Let’s inspect the ground truth codes file<a class="headerlink" href="#Let's-inspect-the-ground-truth-codes-file" title="Permalink to this headline">¶</a></h3>
<p>This contains the ground truth codes and information dataframe. This is a dataframe that is indexed by the annotation group name and has the following columns:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">group</span></code>: group name of annotation (string), eg. “mostly_tumor”</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GT_code</span></code>: int, desired ground truth code (in the mask) Pixels of this value belong to corresponding group (class)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">color</span></code>: str, rgb format. eg. rgb(255,0,0).</p></li>
</ul>
<p><strong>IMPORTANT NOTE:</strong></p>
<p>Zero pixels have special meaning and do NOT encode specific ground truth class. Instead, they simply mean ‘Outside ROI’ and should be IGNORED during model training or evaluation.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># read GTCodes dataframe</span>
<span class="n">GTCODE_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">CWD</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;plugin_tests&#39;</span><span class="p">,</span> <span class="s1">&#39;test_files&#39;</span><span class="p">,</span> <span class="s1">&#39;sample_GTcodes.csv&#39;</span><span class="p">)</span>
<span class="n">GTCodes_df</span> <span class="o">=</span> <span class="n">read_csv</span><span class="p">(</span><span class="n">GTCODE_PATH</span><span class="p">)</span>
<span class="n">GTCodes_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">GTCodes_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;group&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">GTCodes_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>group</th>
      <th>overlay_order</th>
      <th>GT_code</th>
      <th>is_roi</th>
      <th>is_background_class</th>
      <th>color</th>
      <th>comments</th>
    </tr>
    <tr>
      <th>group</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>roi</th>
      <td>roi</td>
      <td>0</td>
      <td>255</td>
      <td>1</td>
      <td>0</td>
      <td>rgb(200,0,150)</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>evaluation_roi</th>
      <td>evaluation_roi</td>
      <td>0</td>
      <td>254</td>
      <td>1</td>
      <td>0</td>
      <td>rgb(255,0,0)</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>mostly_tumor</th>
      <td>mostly_tumor</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>rgb(255,0,0)</td>
      <td>core class</td>
    </tr>
    <tr>
      <th>mostly_stroma</th>
      <td>mostly_stroma</td>
      <td>2</td>
      <td>2</td>
      <td>0</td>
      <td>1</td>
      <td>rgb(255,125,0)</td>
      <td>core class</td>
    </tr>
    <tr>
      <th>mostly_lymphocytic_infiltrate</th>
      <td>mostly_lymphocytic_infiltrate</td>
      <td>1</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>rgb(0,0,255)</td>
      <td>core class</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</div>
<div class="section" id="Read-and-visualize-mask">
<h3>Read and visualize mask<a class="headerlink" href="#Read-and-visualize-mask" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># read mask</span>
<span class="n">X_OFFSET</span> <span class="o">=</span> <span class="mi">59206</span>
<span class="n">Y_OFFSET</span> <span class="o">=</span> <span class="mi">33505</span>
<span class="n">MASKNAME</span> <span class="o">=</span> <span class="s2">&quot;TCGA-A2-A0YE-01Z-00-DX1.8A2E3094-5755-42BC-969D-7F0A2ECA0F39&quot;</span> <span class="o">+</span> \
    <span class="s2">&quot;_left-</span><span class="si">%d</span><span class="s2">_top-</span><span class="si">%d</span><span class="s2">_mag-BASE.png&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">X_OFFSET</span><span class="p">,</span> <span class="n">Y_OFFSET</span><span class="p">)</span>
<span class="n">MASKPATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CWD</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;plugin_tests&#39;</span><span class="p">,</span> <span class="s1">&#39;test_files&#39;</span><span class="p">,</span> <span class="n">MASKNAME</span><span class="p">)</span>
<span class="n">MASK</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="n">MASKPATH</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">MASK</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">MASKNAME</span><span class="p">[:</span><span class="mi">23</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_masks_to_annotations_handler_9_0.png" src="../_images/examples_masks_to_annotations_handler_9_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="2.-Get-contours-from-mask">
<h2>2. Get contours from mask<a class="headerlink" href="#2.-Get-contours-from-mask" title="Permalink to this headline">¶</a></h2>
<div class="section" id="This-is-the-core-method-you-want-to-look-at">
<h3>This is the core method you want to look at<a class="headerlink" href="#This-is-the-core-method-you-want-to-look-at" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">get_contours_from_mask</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Parse ground truth mask and gets countours for annotations.

    Parameters
    -----------
    MASK : nd array
        ground truth mask (m,n) where pixel values encode group membership.
    GTCodes_df : pandas Dataframe
        the ground truth codes and information dataframe.
        This is a dataframe that is indexed by the annotation group name and
        has the following columns.

        group: str
            group name of annotation, eg. mostly_tumor.
        GT_code: int
            desired ground truth code (in the mask). Pixels of this value
            belong to corresponding group (class).
        color: str
            rgb format. eg. rgb(255,0,0).
    groups_to_get : None
        if None (default) then all groups (ground truth labels) will be
        extracted. Otherwise pass a list fo strings like [&#39;mostly_tumor&#39;,].
    MIN_SIZE : int
        minimum bounding box size of contour
    MAX_SIZE : None
        if not None, int. Maximum bounding box size of contour. Sometimes
        very large contours cause segmentation faults that originate from
        opencv and are not caught by python, causing the python process
        to unexpectedly hault. If you would like to set a maximum size to
        defend against this, a suggested maximum would be 15000.
    get_roi_contour : bool
        whether to get contour for boundary of region of interest (ROI). This
        is most relevant when dealing with multiple ROIs per slide and with
        rotated rectangular or polygonal ROIs.
    roi_group : str
        name of roi group in the GT_Codes dataframe (eg roi)
    discard_nonenclosed_background : bool
        If a background group contour is NOT fully enclosed, discard it.
        This is a purely aesthetic method, makes sure that the background group
        contours (eg stroma) are discarded by default to avoid cluttering the
        field when posted to DSA for viewing online. The only exception is
        if they are enclosed within something else (eg tumor), in which case
        they are kept since they represent holes. This is related to
        https://github.com/DigitalSlideArchive/HistomicsTK/issues/675
        WARNING - This is a bit slower since the contours will have to be
        converted to shapely polygons. It is not noticeable for hundreds of
        contours, but you will notice the speed difference if you are parsing
        thousands of contours. Default, for this reason, is False.
    background_group : str
        name of background group in the GT_codes dataframe (eg mostly_stroma)
    verbose : bool
        Print progress to screen?
    monitorPrefix : str
        text to prepend to printed statements

    Returns
    --------
    pandas DataFrame
        contours extracted from input mask. The following columns are output.

        group : str
            annotation group (ground truth label).
        color : str
            annotation color if it were to be posted to DSA.
        is_roi : bool
            whether this annotation is a region of interest boundary
        ymin : int
            minimun y coordinate
        ymax : int
            maximum y coordinate
        xmin : int
            minimum x coordinate
        xmax : int
            maximum x coordinate
        has_holes : bool
            whether this contour has holes
        touches_edge-top : bool
            whether this contour touches top mask edge
        touches_edge-bottom : bool
            whether this contour touches bottom mask edge
        touches_edge-left : bool
            whether this contour touches left mask edge
        touches_edge-right : bool
            whether this contour touches right mask edge
        coords_x : str
            vertix x coordinates comma-separated values
        coords_y
            vertix y coordinated comma-separated values


</pre></div></div>
</div>
<p>As you can see, there are many parameters that you can set, but don’t worry, most parameters have sensible defaults in case you get confused. The only require parameters are <code class="docutils literal notranslate"><span class="pre">MASK</span></code> and <code class="docutils literal notranslate"><span class="pre">GTCodes_df</span></code>, but you may want to consider setting the following parameters based on your specific needs: <code class="docutils literal notranslate"><span class="pre">get_roi_contour</span></code>, <code class="docutils literal notranslate"><span class="pre">roi_group</span></code>, <code class="docutils literal notranslate"><span class="pre">discard_nonenclosed_background</span></code>, <code class="docutils literal notranslate"><span class="pre">background_group</span></code>, which control the method’s behaviour regarding region of interest (ROI) boundary and background pixel class (eg
stroma).</p>
</div>
<div class="section" id="Extract-contours">
<h3>Extract contours<a class="headerlink" href="#Extract-contours" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Let&#39;s extract all contours from a mask, including ROI boundary. We will</span>
<span class="c1"># be discarding any stromal contours that are not fully enclosed within a</span>
<span class="c1"># non-stromal contour since we already know that stroma is the background</span>
<span class="c1"># group. This is so things look uncluttered when posted to DSA.</span>
<span class="n">groups_to_get</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">contours_df</span> <span class="o">=</span> <span class="n">get_contours_from_mask</span><span class="p">(</span>
    <span class="n">MASK</span><span class="o">=</span><span class="n">MASK</span><span class="p">,</span> <span class="n">GTCodes_df</span><span class="o">=</span><span class="n">GTCodes_df</span><span class="p">,</span> <span class="n">groups_to_get</span><span class="o">=</span><span class="n">groups_to_get</span><span class="p">,</span>
    <span class="n">get_roi_contour</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">roi_group</span><span class="o">=</span><span class="s1">&#39;roi&#39;</span><span class="p">,</span>
    <span class="n">discard_nonenclosed_background</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">background_group</span><span class="o">=</span><span class="s1">&#39;mostly_stroma&#39;</span><span class="p">,</span>
    <span class="n">MIN_SIZE</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">MAX_SIZE</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">monitorPrefix</span><span class="o">=</span><span class="n">MASKNAME</span><span class="p">[:</span><span class="mi">12</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;: getting contours&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
TCGA-A2-A0YE: getting contours: non-roi: roi: NO OBJECTS!!
TCGA-A2-A0YE: getting contours: non-roi: evaluation_roi: NO OBJECTS!!
TCGA-A2-A0YE: getting contours: non-roi: mostly_tumor: getting contours
TCGA-A2-A0YE: getting contours: non-roi: mostly_tumor: adding contours
TCGA-A2-A0YE: getting contours: non-roi: mostly_stroma: getting contours
TCGA-A2-A0YE: getting contours: non-roi: mostly_stroma: adding contours
TCGA-A2-A0YE: getting contours: non-roi: nest 1 of 11: TOO SIMPLE (1 coordinates) -- IGNORED
TCGA-A2-A0YE: getting contours: non-roi: nest 2 of 11: TOO SIMPLE (2 coordinates) -- IGNORED
TCGA-A2-A0YE: getting contours: non-roi: nest 3 of 11: TOO SIMPLE (1 coordinates) -- IGNORED
TCGA-A2-A0YE: getting contours: non-roi: nest 4 of 11: TOO SIMPLE (1 coordinates) -- IGNORED
TCGA-A2-A0YE: getting contours: non-roi: nest 5 of 11: TOO SMALL (10 x 18 pixels) -- IGNORED
TCGA-A2-A0YE: getting contours: non-roi: nest 6 of 11: TOO SIMPLE (1 coordinates) -- IGNORED
TCGA-A2-A0YE: getting contours: non-roi: nest 8 of 11: TOO SIMPLE (1 coordinates) -- IGNORED
TCGA-A2-A0YE: getting contours: non-roi: nest 9 of 11: TOO SIMPLE (1 coordinates) -- IGNORED
TCGA-A2-A0YE: getting contours: non-roi: mostly_lymphocytic_infiltrate: getting contours
TCGA-A2-A0YE: getting contours: non-roi: mostly_lymphocytic_infiltrate: adding contours
TCGA-A2-A0YE: getting contours: non-roi: nest 5 of 14: TOO SMALL (23 x 74 pixels) -- IGNORED
TCGA-A2-A0YE: getting contours: non-roi: necrosis_or_debris: NO OBJECTS!!
TCGA-A2-A0YE: getting contours: non-roi: glandular_secretions: NO OBJECTS!!
TCGA-A2-A0YE: getting contours: non-roi: mostly_blood: NO OBJECTS!!
TCGA-A2-A0YE: getting contours: non-roi: exclude: getting contours
TCGA-A2-A0YE: getting contours: non-roi: exclude: adding contours
TCGA-A2-A0YE: getting contours: non-roi: metaplasia_NOS: NO OBJECTS!!
TCGA-A2-A0YE: getting contours: non-roi: mostly_fat: NO OBJECTS!!
TCGA-A2-A0YE: getting contours: non-roi: mostly_plasma_cells: NO OBJECTS!!
TCGA-A2-A0YE: getting contours: non-roi: other_immune_infiltrate: NO OBJECTS!!
TCGA-A2-A0YE: getting contours: non-roi: mostly_mucoid_material: NO OBJECTS!!
TCGA-A2-A0YE: getting contours: non-roi: normal_acinus_or_duct: getting contours
TCGA-A2-A0YE: getting contours: non-roi: normal_acinus_or_duct: adding contours
TCGA-A2-A0YE: getting contours: non-roi: lymphatics: NO OBJECTS!!
TCGA-A2-A0YE: getting contours: non-roi: undetermined: NO OBJECTS!!
TCGA-A2-A0YE: getting contours: non-roi: nerve: NO OBJECTS!!
TCGA-A2-A0YE: getting contours: non-roi: skin_adnexia: NO OBJECTS!!
TCGA-A2-A0YE: getting contours: non-roi: blood_vessel: getting contours
TCGA-A2-A0YE: getting contours: non-roi: blood_vessel: adding contours
TCGA-A2-A0YE: getting contours: non-roi: angioinvasion: NO OBJECTS!!
TCGA-A2-A0YE: getting contours: non-roi: mostly_dcis: NO OBJECTS!!
TCGA-A2-A0YE: getting contours: non-roi: other: NO OBJECTS!!
TCGA-A2-A0YE: getting contours: discarding backgrnd: discarded 2 contours
TCGA-A2-A0YE: getting contours: roi: roi: getting contours
TCGA-A2-A0YE: getting contours: roi: roi: adding contours
</pre></div></div>
</div>
</div>
<div class="section" id="Let's-inspect-the-resultant-contours-dataframe">
<h3>Let’s inspect the resultant contours dataframe<a class="headerlink" href="#Let's-inspect-the-resultant-contours-dataframe" title="Permalink to this headline">¶</a></h3>
<p>The columns that really matter here are <code class="docutils literal notranslate"><span class="pre">group</span></code>, <code class="docutils literal notranslate"><span class="pre">color</span></code>, <code class="docutils literal notranslate"><span class="pre">coords_x</span></code>, and <code class="docutils literal notranslate"><span class="pre">coords_y</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">contours_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>group</th>
      <th>color</th>
      <th>ymin</th>
      <th>ymax</th>
      <th>xmin</th>
      <th>xmax</th>
      <th>has_holes</th>
      <th>touches_edge-top</th>
      <th>touches_edge-left</th>
      <th>touches_edge-bottom</th>
      <th>touches_edge-right</th>
      <th>coords_x</th>
      <th>coords_y</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>roi</td>
      <td>rgb(200,0,150)</td>
      <td>0.0</td>
      <td>4593.0</td>
      <td>0.0</td>
      <td>4541.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>2835,2834,2833,2832,2831,2830,2829,2827,2826,2...</td>
      <td>0,1,1,2,2,3,3,5,5,6,6,8,8,9,9,10,10,12,12,13,1...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>mostly_tumor</td>
      <td>rgb(255,0,0)</td>
      <td>4269.0</td>
      <td>4560.0</td>
      <td>1639.0</td>
      <td>2039.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1673,1672,1668,1667,1662,1661,1659,1658,1658,1...</td>
      <td>4269,4270,4270,4271,4271,4272,4272,4273,4274,4...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>mostly_tumor</td>
      <td>rgb(255,0,0)</td>
      <td>3764.0</td>
      <td>4282.0</td>
      <td>1607.0</td>
      <td>2187.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1770,1769,1768,1767,1765,1764,1762,1761,1760,1...</td>
      <td>3764,3765,3765,3766,3766,3767,3767,3768,3768,3...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>mostly_tumor</td>
      <td>rgb(255,0,0)</td>
      <td>3712.0</td>
      <td>4051.0</td>
      <td>1201.0</td>
      <td>1411.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1214,1213,1211,1210,1208,1207,1206,1205,1203,1...</td>
      <td>3712,3713,3713,3714,3714,3715,3715,3716,3716,3...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>mostly_tumor</td>
      <td>rgb(255,0,0)</td>
      <td>3356.0</td>
      <td>3748.0</td>
      <td>3108.0</td>
      <td>3540.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>3342,3341,3337,3336,3332,3331,3328,3327,3326,3...</td>
      <td>3356,3357,3357,3358,3358,3359,3359,3360,3360,3...</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</div>
</div>
<div class="section" id="3.-Get-annotation-documents-from-contours">
<h2>3. Get annotation documents from contours<a class="headerlink" href="#3.-Get-annotation-documents-from-contours" title="Permalink to this headline">¶</a></h2>
<div class="section" id="This-is-the-core-method-you-want-to-look-at">
<h3>This is the core method you want to look at<a class="headerlink" href="#This-is-the-core-method-you-want-to-look-at" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">get_annotation_documents_from_contours</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Given dataframe of contours, get list of annotation documents.

    This method parses a dataframe of contours to a list of dictionaries, each
    of which represents and large_image style annotation. This is a wrapper
    that extends the functionality of the method
    get_single_annotation_document_from_contours(), whose docstring should
    be referenced for implementation details and further explanation.

    Parameters
    -----------
    contours_df : pandas DataFrame
        WARNING - This is modified inside the function, so pass a copy.
        This dataframe includes data on contours extracted from input mask
        using get_contours_from_mask(). If you have contours using some other
        method, just make sure the dataframe follows the same schema as the
        output from get_contours_from_mask(). You may find a sample dataframe
        in thie repo at ./plugin_tests/test_files/sample_contours_df.tsv
        The following columns are relevant for this method.

        group : str
            annotation group (ground truth label).
        color : str
            annotation color if it were to be posted to DSA.
        coords_x : str
            vertix x coordinates comma-separated values
        coords_y
            vertix y coordinated comma-separated values
    separate_docs_by_group : bool
        if set to True, you get one or more annotation documents (dicts)
        for each group (eg tumor) independently.
    annots_per_doc : int
        maximum number of annotation elements (polygons) per dict. The smaller
        this number, the more numerous the annotation documents, but the more
        seamless it is to post this data to the DSA server or to view using the
        HistomicsTK interface since you will be loading smaller chunks of data
        at a time.
    annprops : dict
        properties of annotation elements. Contains the following keys
        F, X_OFFSET, Y_OFFSET, opacity, lineWidth. Refer to
        get_single_annotation_document_from_contours() for details.
    docnamePrefix : str
        test to prepend to annotation document name
    verbose : bool
        Print progress to screen?
    monitorPrefix : str
        text to prepend to printed statements

    Returns
    --------
    list of dicts
        DSA-style annotation document.


</pre></div></div>
</div>
<p>As mentioned in the docs, this is a wrapper around <code class="docutils literal notranslate"><span class="pre">get_single_annotation_document_from_contours()</span></code>, so let’s inspect it as well.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">get_single_annotation_document_from_contours</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Given dataframe of contours, get annotation document.

    This uses the large_image annotation schema to create an annotation
    document that maybe posted to DSA for viewing using something like:
    resp = gc.post(&#34;/annotation?itemId=&#34; + slide_id, json=annotation_doc)
    The annotation schema can be found at:
    github.com/girder/large_image/blob/master/docs/annotations.md .

    Parameters
    -----------
    contours_df_slice : pandas DataFrame
        The following columns are of relevance and must be contained.

        group : str
            annotation group (ground truth label).
        color : str
            annotation color if it were to be posted to DSA.
        coords_x : str
            vertix x coordinates comma-separated values
        coords_y
            vertix y coordinated comma-separated values
    docname : str
        annotation document name
    F : float
        how much smaller is the mask where the contours come from is relative
        to the slide scan magnification. For example, if the mask is at 10x
        whereas the slide scan magnification is 20x, then F would be 2.0.
    X_OFFSET : int
        x offset to add to contours at BASE (SCAN) magnification
    Y_OFFSET : int
        y offset to add to contours at BASE (SCAN) magnification
    opacity : float
        opacity of annotation elements (in the range [0, 1])
    lineWidth : float
        width of boarders of annotation elements
    verbose : bool
        Print progress to screen?
    monitorPrefix : str
        text to prepend to printed statements

    Returns
    --------
    dict
        DSA-style annotation document ready to be post for viewing.


</pre></div></div>
</div>
<p>Let’s get a list of annotation documents (each is a dictionary). For the purpose of this tutorial, we’ll separate the documents by group (i.e. each document is composed of polygons from the same style/group). You could decide to allow heterogeneous styles in the same annotation document by setting <code class="docutils literal notranslate"><span class="pre">separate_docs_by_group</span></code> to <code class="docutils literal notranslate"><span class="pre">False</span></code>. We’ll group every 10 polygons in the same document for this demo (any extras are grouped with the last document), but realistically you’d want to use a large
number, perhapd 200. Don’t set it to an extremely large number though (not more than, say, 1000) to avoid performance issues when posting these documents or viewing them on DSA.</p>
</div>
<div class="section" id="Get-annotation-documents">
<h3>Get annotation documents<a class="headerlink" href="#Get-annotation-documents" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># get list of annotation documents</span>
<span class="n">annprops</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;X_OFFSET&#39;</span><span class="p">:</span> <span class="n">X_OFFSET</span><span class="p">,</span>
    <span class="s1">&#39;Y_OFFSET&#39;</span><span class="p">:</span> <span class="n">Y_OFFSET</span><span class="p">,</span>
    <span class="s1">&#39;opacity&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
    <span class="s1">&#39;lineWidth&#39;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">annotation_docs</span> <span class="o">=</span> <span class="n">get_annotation_documents_from_contours</span><span class="p">(</span>
    <span class="n">contours_df</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">separate_docs_by_group</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">annots_per_doc</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">docnamePrefix</span><span class="o">=</span><span class="s1">&#39;demo&#39;</span><span class="p">,</span> <span class="n">annprops</span><span class="o">=</span><span class="n">annprops</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">monitorPrefix</span><span class="o">=</span><span class="n">MASKNAME</span><span class="p">[:</span><span class="mi">12</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;: annotation docs&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
TCGA-A2-A0YE: annotation docs: normal_acinus_or_duct: doc 1 of 1: contour 1 of 2
TCGA-A2-A0YE: annotation docs: normal_acinus_or_duct: doc 1 of 1: contour 2 of 2
TCGA-A2-A0YE: annotation docs: exclude: doc 1 of 1: contour 1 of 1
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 1 of 2: contour 1 of 10
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 1 of 2: contour 2 of 10
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 1 of 2: contour 3 of 10
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 1 of 2: contour 4 of 10
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 1 of 2: contour 5 of 10
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 1 of 2: contour 6 of 10
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 1 of 2: contour 7 of 10
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 1 of 2: contour 8 of 10
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 1 of 2: contour 9 of 10
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 1 of 2: contour 10 of 10
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 2 of 2: contour 1 of 15
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 2 of 2: contour 2 of 15
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 2 of 2: contour 3 of 15
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 2 of 2: contour 4 of 15
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 2 of 2: contour 5 of 15
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 2 of 2: contour 6 of 15
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 2 of 2: contour 7 of 15
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 2 of 2: contour 8 of 15
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 2 of 2: contour 9 of 15
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 2 of 2: contour 10 of 15
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 2 of 2: contour 11 of 15
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 2 of 2: contour 12 of 15
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 2 of 2: contour 13 of 15
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 2 of 2: contour 14 of 15
TCGA-A2-A0YE: annotation docs: mostly_tumor: doc 2 of 2: contour 15 of 15
TCGA-A2-A0YE: annotation docs: mostly_stroma: doc 1 of 1: contour 1 of 1
TCGA-A2-A0YE: annotation docs: mostly_lymphocytic_infiltrate: doc 1 of 1: contour 1 of 13
TCGA-A2-A0YE: annotation docs: mostly_lymphocytic_infiltrate: doc 1 of 1: contour 2 of 13
TCGA-A2-A0YE: annotation docs: mostly_lymphocytic_infiltrate: doc 1 of 1: contour 3 of 13
TCGA-A2-A0YE: annotation docs: mostly_lymphocytic_infiltrate: doc 1 of 1: contour 4 of 13
TCGA-A2-A0YE: annotation docs: mostly_lymphocytic_infiltrate: doc 1 of 1: contour 5 of 13
TCGA-A2-A0YE: annotation docs: mostly_lymphocytic_infiltrate: doc 1 of 1: contour 6 of 13
TCGA-A2-A0YE: annotation docs: mostly_lymphocytic_infiltrate: doc 1 of 1: contour 7 of 13
TCGA-A2-A0YE: annotation docs: mostly_lymphocytic_infiltrate: doc 1 of 1: contour 8 of 13
TCGA-A2-A0YE: annotation docs: mostly_lymphocytic_infiltrate: doc 1 of 1: contour 9 of 13
TCGA-A2-A0YE: annotation docs: mostly_lymphocytic_infiltrate: doc 1 of 1: contour 10 of 13
TCGA-A2-A0YE: annotation docs: mostly_lymphocytic_infiltrate: doc 1 of 1: contour 11 of 13
TCGA-A2-A0YE: annotation docs: mostly_lymphocytic_infiltrate: doc 1 of 1: contour 12 of 13
TCGA-A2-A0YE: annotation docs: mostly_lymphocytic_infiltrate: doc 1 of 1: contour 13 of 13
TCGA-A2-A0YE: annotation docs: roi: doc 1 of 1: contour 1 of 1
TCGA-A2-A0YE: annotation docs: blood_vessel: doc 1 of 1: contour 1 of 3
TCGA-A2-A0YE: annotation docs: blood_vessel: doc 1 of 1: contour 2 of 3
TCGA-A2-A0YE: annotation docs: blood_vessel: doc 1 of 1: contour 3 of 3
</pre></div></div>
</div>
</div>
<div class="section" id="Let's-inspect-one-of-the-documents.">
<h3>Let’s inspect one of the documents.<a class="headerlink" href="#Let's-inspect-one-of-the-documents." title="Permalink to this headline">¶</a></h3>
<p>We’ll limit to first two elements (polygons) and we’ll limit the vertices to first couple to be able to see it clearly.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ann_doc</span> <span class="o">=</span> <span class="n">annotation_docs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">ann_doc</span><span class="p">[</span><span class="s1">&#39;elements&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ann_doc</span><span class="p">[</span><span class="s1">&#39;elements&#39;</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">ann_doc</span><span class="p">[</span><span class="s1">&#39;elements&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;points&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ann_doc</span><span class="p">[</span><span class="s1">&#39;elements&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;points&#39;</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ann_doc</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;description&#39;: &#39;&#39;,
 &#39;elements&#39;: [{&#39;closed&#39;: True,
   &#39;fillColor&#39;: &#39;rgba(0,255,0,0.2)&#39;,
   &#39;group&#39;: &#39;normal_acinus_or_duct&#39;,
   &#39;label&#39;: {&#39;value&#39;: &#39;normal_acinus_or_duct&#39;},
   &#39;lineColor&#39;: &#39;rgb(0,255,0)&#39;,
   &#39;lineWidth&#39;: 4.0,
   &#39;points&#39;: [[62081.0, 36019.0, 0.0],
    [62081.0, 36021.0, 0.0],
    [62080.0, 36022.0, 0.0],
    [62080.0, 36025.0, 0.0],
    [62079.0, 36026.0, 0.0]],
   &#39;type&#39;: &#39;polyline&#39;},
  {&#39;closed&#39;: True,
   &#39;fillColor&#39;: &#39;rgba(0,255,0,0.2)&#39;,
   &#39;group&#39;: &#39;normal_acinus_or_duct&#39;,
   &#39;label&#39;: {&#39;value&#39;: &#39;normal_acinus_or_duct&#39;},
   &#39;lineColor&#39;: &#39;rgb(0,255,0)&#39;,
   &#39;lineWidth&#39;: 4.0,
   &#39;points&#39;: [[61743.0, 35806.0, 0.0],
    [61742.0, 35807.0, 0.0],
    [61741.0, 35807.0, 0.0],
    [61740.0, 35808.0, 0.0],
    [61738.0, 35808.0, 0.0]],
   &#39;type&#39;: &#39;polyline&#39;}],
 &#39;name&#39;: &#39;demo_normal_acinus_or_duct-0&#39;}
</pre></div></div>
</div>
</div>
<div class="section" id="Now-we-post-it-to-DSA-HistomicsTK-slide">
<h3>Now we post it to DSA HistomicsTK slide<a class="headerlink" href="#Now-we-post-it-to-DSA-HistomicsTK-slide" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># deleting existing annotations in target slide (if any)</span>
<span class="n">existing_annotations</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/annotation/item/&#39;</span> <span class="o">+</span> <span class="n">SAMPLE_SLIDE_ID</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ann</span> <span class="ow">in</span> <span class="n">existing_annotations</span><span class="p">:</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;/annotation/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ann</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">])</span>

<span class="c1"># post the annotation documents you created</span>
<span class="k">for</span> <span class="n">annotation_doc</span> <span class="ow">in</span> <span class="n">annotation_docs</span><span class="p">:</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">&quot;/annotation?itemId=&quot;</span> <span class="o">+</span> <span class="n">SAMPLE_SLIDE_ID</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">annotation_doc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now you can go to:</p>
<p><a class="reference external" href="http://candygram.neurology.emory.edu:8080/histomicstk#?image=5d586d76bd4404c6b1f286ae&amp;bounds=54743%2C32609%2C68828%2C39395%2C0">TCGA-A2-A0YE-01Z-00-DX1</a></p>
<p>and confirm that the posted annotations make sense and correspond to tissue boundaries and expected labels.</p>
</div>
</div>
<div class="section" id="4.-[EXTRA]---Explore-some-of-the-inner-workings">
<h2>4. [EXTRA] - Explore some of the inner workings<a class="headerlink" href="#4.-[EXTRA]---Explore-some-of-the-inner-workings" title="Permalink to this headline">¶</a></h2>
<div class="section" id="Core-method-being-called-to-get-contours-from-binary-mask">
<h3>Core method being called to get contours from binary mask<a class="headerlink" href="#Core-method-being-called-to-get-contours-from-binary-mask" title="Permalink to this headline">¶</a></h3>
<p>This relies on <code class="docutils literal notranslate"><span class="pre">opencv</span></code> and gets contours from a binary mask and their hierarchy.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">get_contours_from_bin_mask</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Given a binary mask, get opencv contours.

    Parameters
    -----------
    bin_mask : nd array
        ground truth mask (m,n) - int32 with [0, 1] values.

    Returns
    --------
    dict
        a dictionary with the following keys:
            contour group - the actual contour x,y coordinates.
            heirarchy - contour hierarchy. This contains information about
                how contours relate to each other, in the form:
                [Next, Previous, First_Child, Parent,
                index_relative_to_contour_group]
                The last column is added for convenience and is not part of the
                original opencv output.
            outer_contours - index of contours that do not have a parent, and
                are therefore the outermost most contours. These may have
                children (holes), however.
        See docs.opencv.org/3.1.0/d9/d8b/tutorial_py_contours_hierarchy.html
        for more information.


</pre></div></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="polygon_merger.html" class="btn btn-neutral float-right" title="Polygon merger" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="annotations_to_masks_handler.html" class="btn btn-neutral float-left" title="Annotations to masks workflow" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Kitware, Inc.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>