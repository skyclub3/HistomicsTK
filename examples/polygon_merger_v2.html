

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Polygon merger v2 &mdash; HistomicsTK 0.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Tissue Detection module" href="tissue_detection.html" />
    <link rel="prev" title="Polygon merger" href="polygon_merger.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> HistomicsTK
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-docs.html">API Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="wsi-io-using-large-image.html">Reading Whole-slide Images using Large-image</a></li>
<li class="toctree-l2"><a class="reference internal" href="color-deconvolution.html">Color Deconvolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="color-normalization-and-augmentation.html">Color normalization</a></li>
<li class="toctree-l2"><a class="reference internal" href="color-normalization-and-augmentation.html#&quot;Smart&quot;-color-augmentation">“Smart” color augmentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="nuclei-segmentation.html">Nuclei Segmentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="positive-pixel-count.html">Positive Pixel Count</a></li>
<li class="toctree-l2"><a class="reference internal" href="annotations_to_masks_handler.html">Annotations to masks workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="masks_to_annotations_handler.html">Masks to annotations workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="polygon_merger.html">Polygon merger</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Polygon merger v2</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#1.-Constants-&amp;-prep-work">1. Constants &amp; prep work</a></li>
<li class="toctree-l3"><a class="reference internal" href="#2.-Polygon-merger">2. Polygon merger</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#This-is-the-class-object-you-will-be-using">This is the class object you will be using</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Required-arguments-for-init">Required arguments for init</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#3.-Let's-init-and-run-the-merger">3. Let’s init and run the merger</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#This-is-the-result">This is the result</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#4.-(Optional)---Visualize-results-on-HistomicsTK">4. (Optional) - Visualize results on HistomicsTK</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tissue_detection.html">Tissue Detection module</a></li>
<li class="toctree-l2"><a class="reference internal" href="cellularity_detection_thresholding.html">Cellularity detection using thresholding</a></li>
<li class="toctree-l2"><a class="reference internal" href="cellularity_detection_superpixels.html">Cellularity detection using superpixels</a></li>
<li class="toctree-l2"><a class="reference internal" href="workflows.html">Workflows</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authors.html">Credits</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">HistomicsTK</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../examples.html">Examples</a> &raquo;</li>
        
      <li>Polygon merger v2</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/examples/polygon_merger_v2.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    min-width: 5ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Polygon-merger-v2">
<h1>Polygon merger v2<a class="headerlink" href="#Polygon-merger-v2" title="Permalink to this headline">¶</a></h1>
<p><strong>Overview:</strong></p>
<p>This includes functionality to merge polygons from a whole-slide image using an R-tree spatial querying database. This is a generalization of the <code class="docutils literal notranslate"><span class="pre">polygon_merger.py</span></code> class which was specific to the case of tiled masks from segmentation algorithms. In brief, here is when it is appropriate to use either workflow. If you have:</p>
<ul class="simple">
<li><p><strong>Tiled masks from segmentation algorithm</strong>: Use <code class="docutils literal notranslate"><span class="pre">polygon_merger.py</span></code>. That is likely going to be <strong>faster</strong> than <code class="docutils literal notranslate"><span class="pre">polygon_merger_v2.py</span></code>, since it takes advantage of the known spatial adjacency between segmentation masks and the available functionality in <code class="docutils literal notranslate"><span class="pre">masts_to_annotations_handler.py</span></code> to cut down the search space to a much smaller set of annotations (only those that touch the mak edge). <code class="docutils literal notranslate"><span class="pre">polygon_merger_test.py</span></code> runs in ~20 seconds whereas <code class="docutils literal notranslate"><span class="pre">polygon_merger_v2_test.py</span></code> runs in ~25
seconds (i.e. 20% slower, but it’s not a 100% fair comparison).</p></li>
<li><p><strong>Contours (coordinates) from whole slide image</strong>: Use <code class="docutils literal notranslate"><span class="pre">polygon_merger_v2.py</span></code> (as shown in this notebook). This is <strong>more general</strong> and does not require having masks. It is still quite fast since it relies on R-trees to cut down the search space.</p></li>
</ul>
<p>This module is particularly useful when working with algorithmic segmentation outputs that are small relative to the tissue area. If you need to analyze histological structures that are very large, oftentimes thousands of pixels perimeter-wise, this will be a useful functionality.</p>
<p>This extends on some of the workflows described in Amgad et al, 2019:</p>
<p><strong>Mohamed Amgad, Habiba Elfandy, Hagar Hussein, …, Jonathan Beezley, Deepak R Chittajallu, David Manthey, David A Gutman, Lee A D Cooper, Structured crowdsourcing enables convolutional segmentation of histology images, Bioinformatics, 2019, btz083</strong></p>
<p>This slide used as a test example:</p>
<p><a class="reference external" href="http://candygram.neurology.emory.edu:8080/histomicstk#?image=5d5d6910bd4404c6b1f3d893&amp;bounds=41996%2C43277%2C49947%2C46942%2C0">TCGA-A2-A0YE-01Z-00-DX1</a></p>
<p><strong>This is what the result looks like:</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="k">def</span> <span class="nf">_show_img</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">IMGPATH</span> <span class="o">=</span> <span class="s1">&#39;../../histomicstk/annotations_and_masks/tests/test_files/img/&#39;</span>

<span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">_show_img</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">IMGPATH</span> <span class="o">+</span> <span class="s1">&#39;polygon_merger_unmerged.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;Original&#39;</span><span class="p">)</span>
<span class="n">_show_img</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">IMGPATH</span> <span class="o">+</span> <span class="s1">&#39;polygon_merger_merged.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;Merged&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_polygon_merger_v2_2_0.png" src="../_images/examples_polygon_merger_v2_2_0.png" />
</div>
</div>
<p><strong>Implementation summary</strong></p>
<p>This algorithm fuses polygon clusters in coordinate (not mask) space, which means is can merge almost-arbitrarily large structures without memory issues. The algorithm, in brief, works as follows:</p>
<ul class="simple">
<li><p>Identify contours that that have the same label (eg. tumor)</p></li>
<li><p>Add the bounding boxes from these contours to an <a class="reference external" href="https://en.wikipedia.org/wiki/R-tree">R-tree</a>. The R-tree implementation used here is modified from <a class="reference external" href="https://code.google.com/archive/p/pyrtree/">here</a>, and uses k-means clustering to balance the tree.</p></li>
<li><p>Starting from the bottom of the tree, merge all polygons from leafs that belong to the same nodes.</p></li>
<li><p>Move one level up the hierarchy, each time incoporated merged polygons from nodes that share a common parent. Do this until you get one merged polygon at the root node. The polygons are first dilated a bit to make sure any small gaps are covered, then they are merged and eroded. Note that <code class="docutils literal notranslate"><span class="pre">shapely</span></code> allows us to simply “combine” polygons into a “multi-polygon” object, which means we do not need to check if the polygons actually are within merger threshold. Instead, all polygons
hierarchically combined until we arrive at a single “multi-polygon” object at the root node.</p></li>
<li><p>Save the coordinares from each polygon on the multi-polygon object in a new pandas DataFrame.</p></li>
</ul>
<p>This process ensures that the number of comparisons is <code class="docutils literal notranslate"><span class="pre">&lt;&lt;</span> <span class="pre">n^2</span></code>. This is very important since algorithm complexity plays a key role as whole slide images may contain tens of thousands of objects.</p>
<p><strong>Where to look?</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">|</span><span class="n">_</span> <span class="n">histomicstk</span><span class="o">/</span>
<span class="o">|</span>   <span class="o">|</span><span class="n">_annotations_and_masks</span><span class="o">/</span>
<span class="o">|</span>      <span class="o">|</span><span class="n">_polygon_merger_v2</span><span class="o">.</span><span class="n">py</span>
<span class="o">|</span>      <span class="o">|</span><span class="n">_tests</span><span class="o">/</span>
<span class="o">|</span>         <span class="o">|</span><span class="n">_</span> <span class="n">polygon_merger_v2_test</span><span class="o">.</span><span class="n">py</span>
<span class="o">|</span><span class="n">_</span> <span class="n">docs</span><span class="o">/</span>
    <span class="o">|</span><span class="n">_examples</span><span class="o">/</span>
       <span class="o">|</span><span class="n">_polygon_merger_v2</span><span class="o">.</span><span class="n">ipynb</span>
</pre></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">CWD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CWD</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;histomicstk&#39;</span><span class="p">,</span> <span class="s1">&#39;annotations_and_masks&#39;</span><span class="p">))</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">girder_client</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">read_csv</span>

<span class="kn">from</span> <span class="nn">polygon_merger_v2</span> <span class="kn">import</span> <span class="n">Polygon_merger_v2</span>
<span class="kn">from</span> <span class="nn">masks_to_annotations_handler</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_annotation_documents_from_contours</span><span class="p">,</span> <span class="n">_discard_nonenclosed_background_group</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">annotation_and_mask_utils</span> <span class="kn">import</span> <span class="n">parse_slide_annotations_into_table</span>
</pre></div>
</div>
</div>
<div class="section" id="1.-Constants-&amp;-prep-work">
<h2>1. Constants &amp; prep work<a class="headerlink" href="#1.-Constants-&-prep-work" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">APIURL</span> <span class="o">=</span> <span class="s1">&#39;http://candygram.neurology.emory.edu:8080/api/v1/&#39;</span>
<span class="n">SOURCE_SLIDE_ID</span> <span class="o">=</span> <span class="s1">&#39;5d5d6910bd4404c6b1f3d893&#39;</span>
<span class="n">POST_SLIDE_ID</span> <span class="o">=</span> <span class="s1">&#39;5d586d76bd4404c6b1f286ae&#39;</span>

<span class="n">gc</span> <span class="o">=</span> <span class="n">girder_client</span><span class="o">.</span><span class="n">GirderClient</span><span class="p">(</span><span class="n">apiUrl</span><span class="o">=</span><span class="n">APIURL</span><span class="p">)</span>
<span class="c1"># gc.authenticate(interactive=True)</span>
<span class="n">gc</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">apiKey</span><span class="o">=</span><span class="s1">&#39;kri19nTIGOkWH01TbzRqfohaaDWb6kPecRqGmemb&#39;</span><span class="p">)</span>

<span class="c1"># get and parse slide annotations into dataframe</span>
<span class="n">slide_annotations</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/annotation/item/&#39;</span> <span class="o">+</span> <span class="n">SOURCE_SLIDE_ID</span><span class="p">)</span>
<span class="n">contours_df</span> <span class="o">=</span> <span class="n">parse_slide_annotations_into_table</span><span class="p">(</span><span class="n">slide_annotations</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="2.-Polygon-merger">
<h2>2. Polygon merger<a class="headerlink" href="#2.-Polygon-merger" title="Permalink to this headline">¶</a></h2>
<div class="section" id="This-is-the-class-object-you-will-be-using">
<h3>This is the class object you will be using<a class="headerlink" href="#This-is-the-class-object-you-will-be-using" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">Polygon_merger_v2</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Methods to merge contiguous polygons from whole-slide image.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">Polygon_merger_v2</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Init Polygon_merger object.

        Arguments:
        -----------
        contours_df : pandas DataFrame
            The following columns are needed.

            group : str
                annotation group (ground truth label).
            ymin : int
                minimun y coordinate
            ymax : int
                maximum y coordinate
            xmin : int
                minimum x coordinate
            xmax : int
                maximum x coordinate
            coords_x : str
                vertix x coordinates comma-separated values
            coords_y
                vertix y coordinated comma-separated values
        merge_thresh : int
            how close do the polygons need to be (in pixels) to be merged
        verbose : int
            0 - Do not print to screen
            1 - Print only key messages
            2 - Print everything to screen
        monitorPrefix : str
            text to prepend to printed statements


</pre></div></div>
</div>
</div>
<div class="section" id="Required-arguments-for-init">
<h3>Required arguments for init<a class="headerlink" href="#Required-arguments-for-init" title="Permalink to this headline">¶</a></h3>
<p>The only required argument is a dataframe of contours merge.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">contours_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>annidx</th>
      <th>elementidx</th>
      <th>type</th>
      <th>group</th>
      <th>color</th>
      <th>xmin</th>
      <th>xmax</th>
      <th>ymin</th>
      <th>ymax</th>
      <th>bbox_area</th>
      <th>coords_x</th>
      <th>coords_y</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>polyline</td>
      <td>mostly_tumor</td>
      <td>rgb(255,0,0)</td>
      <td>44457</td>
      <td>44703</td>
      <td>44191</td>
      <td>44260</td>
      <td>16974</td>
      <td>44614,44613,44608,44607,44602,44601,44596,4459...</td>
      <td>44191,44192,44192,44193,44193,44194,44194,4419...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>1</td>
      <td>polyline</td>
      <td>mostly_tumor</td>
      <td>rgb(255,0,0)</td>
      <td>44350</td>
      <td>44682</td>
      <td>43750</td>
      <td>44154</td>
      <td>134128</td>
      <td>44350,44350,44353,44354,44359,44360,44364,4436...</td>
      <td>43750,44154,44151,44151,44146,44146,44142,4414...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>0</td>
      <td>polyline</td>
      <td>roi</td>
      <td>rgb(200,0,150)</td>
      <td>44350</td>
      <td>44860</td>
      <td>43750</td>
      <td>44260</td>
      <td>260100</td>
      <td>44350,44350,44860,44860,44350</td>
      <td>43750,44260,44260,43750,43750</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2</td>
      <td>0</td>
      <td>polyline</td>
      <td>mostly_lymphocytic_infiltrate</td>
      <td>rgb(0,0,255)</td>
      <td>44856</td>
      <td>44860</td>
      <td>43999</td>
      <td>44034</td>
      <td>140</td>
      <td>44860,44858,44858,44857,44857,44856,44856,4485...</td>
      <td>43999,44001,44002,44003,44006,44007,44018,4401...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2</td>
      <td>1</td>
      <td>polyline</td>
      <td>mostly_lymphocytic_infiltrate</td>
      <td>rgb(0,0,255)</td>
      <td>44788</td>
      <td>44860</td>
      <td>43912</td>
      <td>43997</td>
      <td>6120</td>
      <td>44823,44822,44819,44818,44817,44813,44812,4480...</td>
      <td>43912,43913,43913,43914,43914,43918,43918,4392...</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</div>
</div>
<div class="section" id="3.-Let's-init-and-run-the-merger">
<h2>3. Let’s init and run the merger<a class="headerlink" href="#3.-Let's-init-and-run-the-merger" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># init &amp; run polygon merger</span>
<span class="n">pm</span> <span class="o">=</span> <span class="n">Polygon_merger_v2</span><span class="p">(</span><span class="n">contours_df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">pm</span><span class="o">.</span><span class="n">unique_groups</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;roi&quot;</span><span class="p">)</span>
<span class="n">pm</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
: mostly_lymphocytic_infiltrate: set_contours_slice
: mostly_lymphocytic_infiltrate: create_rtree
: mostly_lymphocytic_infiltrate: set_tree_dict
: mostly_lymphocytic_infiltrate: set_hierarchy
: mostly_lymphocytic_infiltrate: get_merged_multipolygon
: mostly_lymphocytic_infiltrate: _add_merged_multipolygon_contours
: mostly_tumor: set_contours_slice
: mostly_tumor: create_rtree
: mostly_tumor: set_tree_dict
: mostly_tumor: set_hierarchy
: mostly_tumor: get_merged_multipolygon
: mostly_tumor: _add_merged_multipolygon_contours
: mostly_stroma: set_contours_slice
: mostly_stroma: create_rtree
: mostly_stroma: set_tree_dict
: mostly_stroma: set_hierarchy
: mostly_stroma: get_merged_multipolygon
: mostly_stroma: _add_merged_multipolygon_contours
</pre></div></div>
</div>
<p><strong>Note</strong>: The following steps are only “aesthetic”, and just ensure the contours look nice when posted to Digital Slide Archive for viewing with GeoGS.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># add colors (aesthetic)</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">pm</span><span class="o">.</span><span class="n">unique_groups</span><span class="p">:</span>
    <span class="n">cs</span> <span class="o">=</span> <span class="n">contours_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">contours_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;group&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">]</span>
    <span class="n">pm</span><span class="o">.</span><span class="n">new_contours</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="n">pm</span><span class="o">.</span><span class="n">new_contours</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;group&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># get rid of nonenclosed stroma (aesthetic)</span>
<span class="n">pm</span><span class="o">.</span><span class="n">new_contours</span> <span class="o">=</span> <span class="n">_discard_nonenclosed_background_group</span><span class="p">(</span>
    <span class="n">pm</span><span class="o">.</span><span class="n">new_contours</span><span class="p">,</span> <span class="n">background_group</span><span class="o">=</span><span class="s2">&quot;mostly_stroma&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="This-is-the-result">
<h3>This is the result<a class="headerlink" href="#This-is-the-result" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pm</span><span class="o">.</span><span class="n">new_contours</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>annidx</th>
      <th>elementidx</th>
      <th>type</th>
      <th>group</th>
      <th>color</th>
      <th>xmin</th>
      <th>xmax</th>
      <th>ymin</th>
      <th>ymax</th>
      <th>bbox_area</th>
      <th>coords_x</th>
      <th>coords_y</th>
      <th>has_holes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>polyline</td>
      <td>mostly_lymphocytic_infiltrate</td>
      <td>rgb(0,0,255)</td>
      <td>44670.0</td>
      <td>45472.0</td>
      <td>43750.0</td>
      <td>44200.0</td>
      <td>360900.0</td>
      <td>44670,44670,44670,44670,44670,44670,44670,4467...</td>
      <td>43901,43901,43907,43907,43908,43908,43909,4391...</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>polyline</td>
      <td>mostly_tumor</td>
      <td>rgb(255,0,0)</td>
      <td>46181.0</td>
      <td>46396.0</td>
      <td>43750.0</td>
      <td>43917.0</td>
      <td>35905.0</td>
      <td>46181,46181,46181,46181,46181,46181,46181,4618...</td>
      <td>43777,43777,43777,43778,43778,43778,43778,4377...</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>polyline</td>
      <td>mostly_tumor</td>
      <td>rgb(255,0,0)</td>
      <td>46312.0</td>
      <td>46396.0</td>
      <td>44167.0</td>
      <td>44350.0</td>
      <td>15372.0</td>
      <td>46312,46312,46312,46312,46312,46312,46315,4631...</td>
      <td>44252,44252,44252,44253,44253,44253,44256,4425...</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>polyline</td>
      <td>mostly_tumor</td>
      <td>rgb(255,0,0)</td>
      <td>44907.0</td>
      <td>46396.0</td>
      <td>44609.0</td>
      <td>46308.0</td>
      <td>2529811.0</td>
      <td>44907,44907,44907,44907,44907,44907,44907,4490...</td>
      <td>46230,46230,46230,46234,46234,46234,46234,4623...</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>polyline</td>
      <td>mostly_tumor</td>
      <td>rgb(255,0,0)</td>
      <td>45822.0</td>
      <td>46086.0</td>
      <td>43824.0</td>
      <td>43953.0</td>
      <td>34056.0</td>
      <td>45822,45822,45822,45822,45822,45822,45822,4582...</td>
      <td>43914,43914,43915,43915,43915,43915,43915,4391...</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</div>
</div>
<div class="section" id="4.-(Optional)---Visualize-results-on-HistomicsTK">
<h2>4. (Optional) - Visualize results on HistomicsTK<a class="headerlink" href="#4.-(Optional)---Visualize-results-on-HistomicsTK" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># deleting existing annotations in target slide (if any)</span>
<span class="n">existing_annotations</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/annotation/item/&#39;</span> <span class="o">+</span> <span class="n">POST_SLIDE_ID</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ann</span> <span class="ow">in</span> <span class="n">existing_annotations</span><span class="p">:</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;/annotation/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ann</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">])</span>

<span class="c1"># get list of annotation documents</span>
<span class="n">annotation_docs</span> <span class="o">=</span> <span class="n">get_annotation_documents_from_contours</span><span class="p">(</span>
    <span class="n">pm</span><span class="o">.</span><span class="n">new_contours</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">separate_docs_by_group</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">docnamePrefix</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">monitorPrefix</span><span class="o">=</span><span class="n">POST_SLIDE_ID</span> <span class="o">+</span> <span class="s2">&quot;: annotation docs&quot;</span><span class="p">)</span>

<span class="c1"># post annotations to slide -- make sure it posts without errors</span>
<span class="k">for</span> <span class="n">annotation_doc</span> <span class="ow">in</span> <span class="n">annotation_docs</span><span class="p">:</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">&quot;/annotation?itemId=&quot;</span> <span class="o">+</span> <span class="n">POST_SLIDE_ID</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">annotation_doc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now you can go to:</p>
<p><a class="reference external" href="http://candygram.neurology.emory.edu:8080/histomicstk#?image=5d586d76bd4404c6b1f286ae&amp;bounds=41996%2C43277%2C49947%2C46942%2C0">TCGA-A2-A0YE-01Z-00-DX1</a></p>
<p>and confirm that the posted annotations make sense and correspond to tissue boundaries and expected labels.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tissue_detection.html" class="btn btn-neutral float-right" title="Tissue Detection module" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="polygon_merger.html" class="btn btn-neutral float-left" title="Polygon merger" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Kitware, Inc.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>