

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Annotations to masks workflow &mdash; HistomicsTK 0.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Masks to annotations workflow" href="histomicstk.annotations_and_masks.masks_to_annotations_handler.html" />
    <link rel="prev" title="histomicstk.annotations_and_masks" href="histomicstk.annotations_and_masks.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> HistomicsTK
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="api-docs.html">API Documentation</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="histomicstk.html">histomicstk</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="histomicstk.utils.html">utils</a></li>
<li class="toctree-l3"><a class="reference internal" href="histomicstk.preprocessing.html">preprocessing</a></li>
<li class="toctree-l3"><a class="reference internal" href="histomicstk.filters.html">filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="histomicstk.segmentation.html">segmentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="histomicstk.features.html">features</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="histomicstk.annotations_and_masks.html">annotations and masks</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">Annotations to masks</a></li>
<li class="toctree-l4"><a class="reference internal" href="histomicstk.annotations_and_masks.masks_to_annotations_handler.html">Masks to annotations</a></li>
<li class="toctree-l4"><a class="reference internal" href="histomicstk.annotations_and_masks.annotation_and_mask_utils.html">Annotation and mask utilities</a></li>
<li class="toctree-l4"><a class="reference internal" href="histomicstk.annotations_and_masks.polygon_merger.html">Polygon merger (overview)</a></li>
<li class="toctree-l4"><a class="reference internal" href="histomicstk.annotations_and_masks.polygon_merger.html#polygon-merger-version-1-from-tiled-masks">Polygon merger (version 1 - from tiled masks)</a></li>
<li class="toctree-l4"><a class="reference internal" href="histomicstk.annotations_and_masks.polygon_merger.html#polygon-merger-version-2-general">Polygon merger (version 2- general)</a></li>
<li class="toctree-l4"><a class="reference internal" href="histomicstk.annotations_and_masks.tips_for_scalable_annotation_rendering_for_developers.html">Tips for scalable annotation rendering for developers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="histomicstk.saliency.html">saliency (tissue/cellularity detection)</a></li>
<li class="toctree-l3"><a class="reference internal" href="histomicstk.workflows.html">workflows</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Credits</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">HistomicsTK</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="api-docs.html">API Documentation</a> &raquo;</li>
        
          <li><a href="histomicstk.html">histomicstk</a> &raquo;</li>
        
          <li><a href="histomicstk.annotations_and_masks.html">histomicstk.annotations_and_masks</a> &raquo;</li>
        
      <li>Annotations to masks workflow</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/histomicstk.annotations_and_masks.annotations_to_masks_handler.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="annotations-to-masks-workflow">
<h1>Annotations to masks workflow<a class="headerlink" href="#annotations-to-masks-workflow" title="Permalink to this headline">¶</a></h1>
<p><strong>Overview:</strong>
This includes tools to parse annotations from an item (slide) into masks to use in training and evaluating imaging algorithms. The basic functionality involves mapping annotation rectangles (potentially rotated) and polygons to regions-of-interest (ROIs) and making one mask per region of interest. This extends on some of the workflows described in Amgad et al, 2019:</p>
<p><em>Mohamed Amgad, Habiba Elfandy, Hagar Hussein, …, Jonathan Beezley, Deepak R Chittajallu, David Manthey, David A Gutman, Lee A D Cooper, Structured crowdsourcing enables convolutional segmentation of histology images, Bioinformatics, , btz083, https://doi.org/10.1093/bioinformatics/btz083</em></p>
<p>This slide used as a test example:</p>
<p><a class="reference external" href="http://candygram.neurology.emory.edu:8080/histomicstk#?image=5d586d57bd4404c6b1f28640&amp;bounds=53566%2C33193%2C68926%2C40593%2C0">TCGA-A2-A0YE-01Z-00-DX1</a></p>
<p>The user uses a csv file like the one in
<code class="docutils literal notranslate"><span class="pre">./tests/test_files/sample_GTcodes.csv</span></code>
to control pixel values assigned to mask, overlay order of various annotation groups, which groups are considered to be ROIs, etc.</p>
<p><strong>Here’s the result:</strong></p>
<p><strong>Before</strong></p>
<a class="reference external image-reference" href="https://user-images.githubusercontent.com/22067552/63966887-46855c80-ca6a-11e9-8431-932fda6cffc1.png"><img alt="image" src="https://user-images.githubusercontent.com/22067552/63966887-46855c80-ca6a-11e9-8431-932fda6cffc1.png" /></a>
<p><strong>After</strong></p>
<p>Saved mask files:</p>
<ul class="simple">
<li><p>TCGA-A2-A0YE-01Z-00-DX1.8A2E3094-5755-42BC-969D-7F0A2ECA0F39_left-59206_top-33505_mag-BASE.png</p></li>
<li><p>TCGA-A2-A0YE-01Z-00-DX1.8A2E3094-5755-42BC-969D-7F0A2ECA0F39_left-58482_top-38217_mag-BASE.png</p></li>
<li><p>TCGA-A2-A0YE-01Z-00-DX1.8A2E3094-5755-42BC-969D-7F0A2ECA0F39_left-57611_top-35827_mag-BASE.png</p></li>
</ul>
<p>The code added here handles the following complex situations:</p>
<ul class="simple">
<li><p>Multiple ROIs per item</p></li>
<li><p>Rotated rectangular annotations and ROIs</p></li>
<li><p>Polygonal ROIs</p></li>
<li><p>Overlapping annotations</p></li>
</ul>
<p><strong>Where to look?</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">|</span><span class="n">_</span> <span class="n">histomicstk</span><span class="o">/</span>
<span class="o">|</span>   <span class="o">|</span><span class="n">_annotations_and_masks</span><span class="o">/</span>
<span class="o">|</span>   <span class="o">|</span>  <span class="o">|</span><span class="n">_annotation_and_mask_utils</span><span class="o">.</span><span class="n">py</span>
<span class="o">|</span>   <span class="o">|</span>  <span class="o">|</span><span class="n">_annotations_to_masks_handler</span><span class="o">.</span><span class="n">py</span>
<span class="o">|</span>   <span class="o">|</span><span class="n">_tests</span><span class="o">/</span>
<span class="o">|</span>       <span class="o">|</span><span class="n">_</span> <span class="n">annotation_and_mask_utils_test</span><span class="o">.</span><span class="n">py</span>
<span class="o">|</span>       <span class="o">|</span><span class="n">_</span> <span class="n">annotations_to_masks_handler_test</span><span class="o">.</span><span class="n">py</span>
<span class="o">|</span>       <span class="o">|</span><span class="n">_test_files</span><span class="o">/</span>
<span class="o">|</span>          <span class="o">|</span><span class="n">_sample_GTcodes</span><span class="o">.</span><span class="n">csv</span>
<span class="o">|</span><span class="n">_</span> <span class="n">docs</span><span class="o">/</span>
    <span class="o">|</span><span class="n">_examples</span><span class="o">/</span>
       <span class="o">|</span><span class="n">_annotations_to_masks_handler</span><span class="o">.</span><span class="n">ipynb</span>
</pre></div>
</div>
<span class="target" id="module-histomicstk.annotations_and_masks.annotations_to_masks_handler"></span><p>Created on Mon Aug 12 18:33:48 2019.</p>
<p>&#64;author: tageldim</p>
<dl class="function">
<dt id="histomicstk.annotations_and_masks.annotations_to_masks_handler.get_all_roi_masks_for_slide">
<code class="sig-prename descclassname">histomicstk.annotations_and_masks.annotations_to_masks_handler.</code><code class="sig-name descname">get_all_roi_masks_for_slide</code><span class="sig-paren">(</span><em class="sig-param">gc</em>, <em class="sig-param">slide_id</em>, <em class="sig-param">GTCODE_PATH</em>, <em class="sig-param">MASK_SAVEPATH</em>, <em class="sig-param">slide_name=None</em>, <em class="sig-param">verbose=True</em>, <em class="sig-param">monitorPrefix=''</em>, <em class="sig-param">get_roi_mask_kwargs={}</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/histomicstk/annotations_and_masks/annotations_to_masks_handler.html#get_all_roi_masks_for_slide"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#histomicstk.annotations_and_masks.annotations_to_masks_handler.get_all_roi_masks_for_slide" title="Permalink to this definition">¶</a></dt>
<dd><p>Parse annotations and saves ground truth masks for ALL ROIs.</p>
<p>Get all ROIs in a single slide. This is a wrapper around get_roi_mask()
which should be referred to for implementation details.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>gc</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#object" title="(in Python v3.8)"><em>object</em></a>) – girder client object to make requests, for example:
gc = girder_client.GirderClient(apiUrl = APIURL)
gc.authenticate(interactive=True)</p></li>
<li><p><strong>slide_id</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.8)"><em>str</em></a>) – girder id for item (slide)</p></li>
<li><p><strong>GTCODE_PATH</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.8)"><em>str</em></a>) – path to the ground truth codes and information
csv file. Refer to the docstring of get_roi_mask() for more info.</p></li>
<li><p><strong>MASK_SAVEPATH</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.8)"><em>str</em></a>) – path to directory to save ROI masks</p></li>
<li><p><strong>(</strong><strong>optional</strong><strong>)</strong> (<em>monitorPrefix</em>) – If not given, it’s inferred using a server request using girder client.</p></li>
<li><p><strong>(</strong><strong>optional</strong><strong>)</strong> – Print progress to screen?</p></li>
<li><p><strong>(</strong><strong>optional</strong><strong>)</strong> – text to prepend to printed statements</p></li>
<li><p><strong>get_roi_mask_kwargs</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.8)"><em>dict</em></a>) – extra kwargs for get_roi_mask()</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>save paths for ROIs</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>list of strs</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="histomicstk.annotations_and_masks.annotations_to_masks_handler.get_roi_mask">
<code class="sig-prename descclassname">histomicstk.annotations_and_masks.annotations_to_masks_handler.</code><code class="sig-name descname">get_roi_mask</code><span class="sig-paren">(</span><em class="sig-param">slide_annotations</em>, <em class="sig-param">element_infos</em>, <em class="sig-param">GTCodes_df</em>, <em class="sig-param">idx_for_roi</em>, <em class="sig-param">iou_thresh=0.0</em>, <em class="sig-param">roiinfo=None</em>, <em class="sig-param">crop_to_roi=True</em>, <em class="sig-param">use_shapely=True</em>, <em class="sig-param">verbose=False</em>, <em class="sig-param">monitorPrefix=''</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/histomicstk/annotations_and_masks/annotations_to_masks_handler.html#get_roi_mask"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#histomicstk.annotations_and_masks.annotations_to_masks_handler.get_roi_mask" title="Permalink to this definition">¶</a></dt>
<dd><p>Parse annotations and gets a ground truth mask for a single ROI.</p>
<p>This will look at all slide annotations and get ones that
overlap with the region of interest (ROI) and assigns them to mask.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>slide_annotations</strong> (<em>list of dicts</em>) – response from server request</p></li>
<li><p><strong>element_infos</strong> (<em>pandas DataFrame.</em>) – The columns annidx and elementidx
encode the dict index of annotation document and element,
respectively, in the original slide_annotations list of dictionaries.
This can be obain by get_bboxes_from_slide_annotations() method</p></li>
<li><p><strong>GTCodes_df</strong> (<em>pandas Dataframe</em>) – the ground truth codes and information dataframe.
WARNING: Modified indide this method so pass a copy.
This is a dataframe that is indexed by the annotation group name and
has the following columns:
- group: group name of annotation (string), eg. mostly_tumor
- overlay_order: int, how early to place the annotation in the
mask. Larger values means this annotation group is overlayed
last and overwrites whatever overlaps it.
- GT_code: int, desired ground truth code (in the mask)
Pixels of this value belong to corresponding group (class)
- is_roi: Flag for whether this group encodes an ROI
- is_background_class: Flag, whether this group is the default
fill value inside the ROI. For example, you may descide that
any pixel inside the ROI is considered stroma.</p></li>
<li><p><strong>idx_for_roi</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.8)"><em>int</em></a>) – index of ROI within the element_infos dataframe.</p></li>
<li><p><strong>iou_thresh</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.8)"><em>float</em></a>) – how much bounding box overlap is enough to
consider an annotation to belong to the region of interest</p></li>
<li><p><strong>roiinfo</strong> (<em>pandas series</em><em> or </em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.8)"><em>dict</em></a>) – contains information about the roi. Keys will be added to this
index containing info about the roi like bounding box
location and size.</p></li>
<li><p><strong>crop_to_roi</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.8)"><em>bool</em></a>) – flag of whether to crop polygons to roi
(prevent overflow beyond roi edge)</p></li>
<li><p><strong>use_shapely</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.8)"><em>bool</em></a>) – flag of whether to precisely determine whether an element
belongs to an ROI using shapely polygons. Slightly slower. If
set to False, overlapping bounding box is used as a cheap but
less precise indicator of inclusion.</p></li>
<li><p><strong>verbose</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.8)"><em>bool</em></a>) – Print progress to screen?</p></li>
<li><p><strong>monitorPrefix</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.8)"><em>str</em></a>) – text to prepend to printed statements</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><em>Np array</em> – (N x 2), where pixel values encode class membership.
IMPORTANT NOTE: Zero pixels have special meaning and do NOT
encode specific ground truth class. Instead, they simply
mean Outside ROI and should be IGNORED during model training
or evaluation.</p></li>
<li><p><em>Dict</em> – information about ROI</p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="histomicstk.annotations_and_masks.masks_to_annotations_handler.html" class="btn btn-neutral float-right" title="Masks to annotations workflow" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="histomicstk.annotations_and_masks.html" class="btn btn-neutral float-left" title="histomicstk.annotations_and_masks" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Kitware, Inc.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>